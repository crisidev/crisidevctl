upstream prometheus {
    server 127.0.0.1:9090;
}

server {
    listen 443 ssl;
    server_name prometheus.crisidev.org;

    ssl on;
    ssl_certificate /etc/letsencrypt/live/metrics.crisidev.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/metrics.crisidev.org/privkey.pem;
    ssl_session_cache shared:SSL:10m;
    ssl_protocols SSLv3 TLSv1;
    ssl_ciphers  ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;
    ssl_prefer_server_ciphers on;

    proxy_set_header Host             $http_host;   # required for docker client's sake
    proxy_set_header X-Real-IP        $remote_addr; # pass on real client's IP
    client_max_body_size 0; # disable any limits to avoid HTTP 413 for large image uploads
    chunked_transfer_encoding on;

    access_log /var/log/nginx/prometheus.crisidev.org-ssl-access.log;
    error_log /var/log/nginx/prometheus.crisidev.org-ssl-error.log;

    location / {
        auth_basic            "Alt!";
        auth_basic_user_file  /etc/nginx/ssl/htpasswd;
        proxy_pass http://prometheus;
        proxy_http_version 1.1;
    }
}

upstream grafana {
    server 127.0.0.1:3000;
}

server {
    listen 443 ssl;
    server_name metrics.crisidev.org;

    ssl on;
    ssl_certificate /etc/letsencrypt/live/metrics.crisidev.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/metrics.crisidev.org/privkey.pem;
    ssl_session_cache shared:SSL:10m;
    ssl_protocols SSLv3 TLSv1;
    ssl_ciphers  ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;
    ssl_prefer_server_ciphers on;

    proxy_set_header Host             $http_host;   # required for docker client's sake
    proxy_set_header X-Real-IP        $remote_addr; # pass on real client's IP
    client_max_body_size 0; # disable any limits to avoid HTTP 413 for large image uploads
    chunked_transfer_encoding on;

    access_log /var/log/nginx/metrics.crisidev.org-ssl-access.log;
    error_log /var/log/nginx/metrics.crisidev.org-ssl-error.log;

    location / {
        proxy_pass http://grafana;
        proxy_http_version 1.1;
    }
}

upstream alertmanager {
    server 127.0.0.1:9093;
}

server {
    listen 443 ssl;
    server_name alert.crisidev.org;

    ssl on;
    ssl_certificate /etc/letsencrypt/live/metrics.crisidev.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/metrics.crisidev.org/privkey.pem;
    ssl_session_cache shared:SSL:10m;
    ssl_protocols SSLv3 TLSv1;
    ssl_ciphers  ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;
    ssl_prefer_server_ciphers on;


    proxy_set_header Host             $http_host;   # required for docker client's sake
    proxy_set_header X-Real-IP        $remote_addr; # pass on real client's IP
    client_max_body_size 0; # disable any limits to avoid HTTP 413 for large image uploads
    chunked_transfer_encoding on;

    access_log /var/log/nginx/alert.crisidev.org-ssl-access.log;
    error_log /var/log/nginx/alert.crisidev.org-ssl-error.log;

    location / {
        auth_basic            "Alt!";
        auth_basic_user_file  /etc/nginx/ssl/htpasswd;
        proxy_pass http://alertmanager;
        proxy_http_version 1.1;
    }
}
